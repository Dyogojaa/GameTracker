@page "/importar"
@using Microsoft.AspNetCore.Components.Forms
@inject HttpClient Http

<h3 class="text-2xl font-bold mb-4">Importação de Jogos (CSV)</h3>

<div class="bg-gray-800 p-6 rounded-lg text-white max-w-lg shadow-lg">
    <p class="mb-3 text-sm text-gray-300">
        Selecione o arquivo CSV exportado do site <b>HowLongToBeat</b> e envie para importar os jogos.
    </p>

    <input type="file" @onchange="OnFileSelected" accept=".csv" class="mb-3 text-black bg-white rounded p-1" />

    @if (file != null)
    {
        <div class="mb-3 text-sm text-gray-200">
            📄 <b>@file.Name</b> (@((file.Size / 1024).ToString("F1")) KB)
        </div>
    }

    <button class="bg-blue-600 text-white px-4 py-2 rounded"
            disabled="@isUploading"
            @onclick="EnviarArquivo">
        @(isUploading ? "Enviando..." : "Importar Arquivo")
    </button>

    @if (!string.IsNullOrEmpty(mensagem))
    {
        <div class="mt-4 p-3 rounded
                        @(sucesso ? "bg-green-600 text-white" : "bg-red-600 text-white")">
            @mensagem
        </div>
    }

    @if (resultado != null)
    {
        <div class="mt-6 bg-gray-700 p-4 rounded">
            <h4 class="text-lg font-semibold mb-2">Resumo da Importação</h4>
            <ul class="list-disc ml-5 text-sm">
                <li>Total de registros no arquivo: <b>@resultado.TotalLidos</b></li>
                <li>Importados com sucesso: <b>@resultado.Sucesso</b></li>
                <li>Ignorados (já existentes): <b>@resultado.Ignorados</b></li>
                <li>Erros: <b>@resultado.Erros</b></li>
            </ul>
        </div>
    }
</div>

@code {
    private IBrowserFile? file;
    private bool isUploading = false;
    private string? mensagem;
    private bool sucesso;
    private ResultadoImportacao? resultado;

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        file = e.File;
        mensagem = null;
        resultado = null;
    }

    private async Task EnviarArquivo()
    {
        if (file == null)
        {
            mensagem = "Selecione um arquivo CSV primeiro.";
            sucesso = false;
            return;
        }

        isUploading = true;
        mensagem = null;

        try
        {
            using var content = new MultipartFormDataContent();
            using var stream = file.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024); // até 20MB
            var fileContent = new StreamContent(stream);
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("text/csv");

            content.Add(fileContent, "arquivo", file.Name);

            var response = await Http.PostAsync("https://localhost:5001/api/importacao/csv", content);

            if (response.IsSuccessStatusCode)
            {
                sucesso = true;
                mensagem = "✅ Importação concluída com sucesso!";
                resultado = await response.Content.ReadFromJsonAsync<ResultadoImportacao>();
            }
            else
            {
                sucesso = false;
                mensagem = $"❌ Erro na importação: {response.ReasonPhrase}";
            }
        }
        catch (Exception ex)
        {
            sucesso = false;
            mensagem = $"Erro inesperado: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }

    public class ResultadoImportacao
    {
        public int TotalLidos { get; set; }
        public int Sucesso { get; set; }
        public int Ignorados { get; set; }
        public int Erros { get; set; }
    }
}
